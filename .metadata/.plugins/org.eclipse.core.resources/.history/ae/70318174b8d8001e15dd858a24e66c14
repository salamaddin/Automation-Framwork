package Lib.Files;

import com.codoid.products.exception.FilloException;
import com.codoid.products.fillo.Connection;
import com.codoid.products.fillo.Fillo;
import com.codoid.products.fillo.Recordset;

public class FilloXL {
	public Recordset rs = null;
	public String xlPath, sheet, where;
	int rowCnt = 0, currRow = 0;

	public Recordset getRecords(String xlPath, String sheet, String cols, String where) throws Exception {
		Fillo fillo = new Fillo();
		Connection con = null;
		this.xlPath = xlPath;
		this.sheet = sheet;
		this.where = where;

		con = fillo.getConnection(xlPath);
		String qry = "Select " + cols + " from " + sheet;
		if (!"".equals(where)) {
			qry = qry + " where " + where;
		}
		try {
			rs = con.executeQuery(qry);
		} catch (Exception e) {

		}

		if (rs != null)
			rowCnt = rs.getCount();

		return rs;
	}

	public Recordset getRecords(String xlPath, String sheet, String where) throws Exception {
		return getRecords(xlPath, sheet, "*", where);
	}

	public Recordset getRecords(String xlPath, String sheet) throws Exception {
		return getRecords(xlPath, sheet, "");
	}

	public boolean next() throws Exception {
		return rs != null && rs.getCount() > 0 && rs.next();
	}

	public void first() throws Exception {
		rs.moveFirst();
		currRow = 0;
	}

	public String get(int row, String fieldName) throws Exception {
		String ret = "";
		if (row < rowCnt) {
			if (row == currRow) {
			} else if (row == currRow + 1) {
				if (rs.hasNext()) {
					rs.next();
					currRow++;
				}
			} else if (row == currRow - 1) {
				rs.movePrevious();
				currRow--;
			}
			ret = rs.getField(fieldName);
		}
		return ret;
	}

	public String get(int index) throws Exception {
		String ret = "";
		try {
			ret = rs.getField(index).value();
		} catch (Exception e) {
		}

		return ret;
	}

	public String get(String fieldName) throws Exception {
		String ret = "";
		try {
			ret = rs.getField(fieldName);
		} catch (Exception e) {
		}

		return ret;
	}

	public int getInt(String fieldName) throws Exception {
		int ret = 0;
		try {
			ret = Integer.parseInt(get(fieldName));
		} catch (Exception e) {
		}
		return ret;
	}

	public int getInt(int index) throws Exception {
		int ret = 0;
		try {
			ret = Integer.parseInt(get(index));
		} catch (Exception e) {
		}
		return ret;
	}

	public int getColCount() throws Exception {
		return rs.getFieldNames().size();
	}

	public void close() throws Exception {
		try {
			rs.close();
		} catch (Exception e) {
		}
	}

	public int getRowCount() throws Exception {
		if (rs != null)
			rowCnt = rs.getCount();
		return rowCnt;
	}

	public String getData(String xlPath, String sheetName, String colName, String where) throws Exception {
		String ret = "";
		try {
			getRecords(xlPath, sheetName, colName, where);
			if (rs.next())
				ret = rs.getField(colName);
		} catch (Exception e) {
		}
		return ret;
	}
	
	public int getRowCountWithoutEmptyRows() throws Exception {
		// Getting remaining row count from current index first - to be able to 
		// move the rs pointer back to its initial position
		int remainingRowsCountFromCurrentRowIndex = getRemainingRowsCountFromCurrentRowIndex();
		int rowCount = 0;

		if (rs != null) {

			rs.moveFirst();
			boolean currRowBlank = true;
			String colName;
			String colVal;
			// if we do not use do wile loop here then first row will be miss and count will
			// be mist match
			do {
				currRowBlank = true;
				for (int i = 0; i < rs.getFieldNames().size(); i++) {
					colName = rs.getFieldNames().get(i);
					colVal = rs.getField(colName);
					if (colVal != null && !colVal.isEmpty()) {
						currRowBlank = false;
						break;

					}
				} // end of for

				if (!currRowBlank) {
					rowCount++;
				}
			} while (rs.next());
		}
		rs.moveFirst();
		// This is for moving back rs pointer to its original pointing location
		if (remainingRowsCountFromCurrentRowIndex > 0) {
			// Adding +1 to calculate right index position from the start
			remainingRowsCountFromCurrentRowIndex = remainingRowsCountFromCurrentRowIndex + 1;
		}
		if (remainingRowsCountFromCurrentRowIndex <= rs.getCount()) {
			movePointerToGivenRowIndex(rs.getCount() - remainingRowsCountFromCurrentRowIndex);
		} else {
			movePointerToGivenRowIndex(remainingRowsCountFromCurrentRowIndex);
		}

		return rowCount;
	}
	
	public int getRemainingRowsCountFromCurrentRowIndex() throws Exception {
		int remainingRowsCount = 0;

		if (rs != null) {
			// Added try catch to understand whether rs is initialized or not and accordingly 
			// keep rowIndex's initial value (rs is not initialized when reading new test data file)
			try {
				rs.getField(rs.getFieldNames().get(0));
			} catch (FilloException e) {
				remainingRowsCount = -1;
			}

			while (rs.next()) {
				remainingRowsCount++;
			}
		}

		return remainingRowsCount;
	}
	
	public void movePointerToGivenRowIndex(int rowIndex) throws Exception {

		if (rowIndex < 0) {
			return;
		}

		if (rs != null) {

			if (rowIndex > rs.getCount()) {
				return;
			}
			if (rowIndex == rs.getCount()) {
				rs.moveLast();
				return;
			}

			int rowCount = 0;
			// if we do not use do wile loop here then first row will be miss and count will
			// be mist match
			do {
				if (rowIndex == rowCount) {
					break;
				}
				rowCount++;
			} while (rs.next());
		}
	}


}
